# Документация пайплайна прогнозирования дебита нефти (WLPR)

## Содержание

1. [Обзор системы](#1-обзор-системы)
2. [Входные данные](#2-входные-данные)
3. [Этап 1: Загрузка и предобработка данных](#3-этап-1-загрузка-и-предобработка-данных)
4. [Этап 2: Конструирование признаков закачки](#4-этап-2-конструирование-признаков-закачки)
5. [Этап 3: Пространственные и временные признаки](#5-этап-3-пространственные-и-временные-признаки)
6. [Этап 4: Физические признаки](#6-этап-4-физические-признаки)
7. [Этап 5: Графовые признаки](#7-этап-5-графовые-признаки)
8. [Этап 6: Модель Chronos-2](#8-этап-6-модель-chronos-2)
9. [Этап 7: Кросс-валидация](#9-этап-7-кросс-валидация)
10. [Этап 8: Метрики и оценка](#10-этап-8-метрики-и-оценка)
11. [Архитектура модулей](#11-архитектура-модулей)
12. [Конфигурация](#12-конфигурация)
13. [Запуск пайплайна](#13-запуск-пайплайна)
14. [Литература и источники](#14-литература-и-источники)

---

## 1. Обзор системы

Пайплайн предназначен для прогнозирования месячного дебита нефти (`wlpr`, тонн/месяц) по добывающим скважинам нефтяного месторождения. Система использует foundation-модель временных рядов **Amazon Chronos-2** (zero-shot, без дообучения) с обогащением входных данных графовыми, пространственными и физическими ковариатами.

**Ключевые особенности:**
- Foundation-модель Chronos-2 работает в режиме zero-shot (без обучения на целевых данных)
- Кросс-обучение (cross-learning): все скважины подаются как единый мультивариативный ряд
- Графовое обогащение: скважины связаны через пространственный граф с DTW-подобием и кластеризацией
- Суперпозиция закачки: вклад каждой нагнетательной скважины моделируется индивидуально
- Физические признаки: индекс продуктивности, перепад давления
- Вероятностное прогнозирование: квантильная регрессия с доверительным интервалом 80%
- Walk-forward кросс-валидация с полной перестройкой признаков на каждом фолде

**Горизонт прогнозирования:** 6 месяцев  
**Частота данных:** месячная (`MS` — начало месяца)  
**Целевая переменная:** `wlpr` — месячный дебит нефти (тонн/месяц)

---

## 2. Входные данные

### 2.1. Промысловые данные (`MODEL_22.09.25.csv`)

CSV-файл с разделителем `;`, содержащий суточные/месячные показатели по всем скважинам (добывающим и нагнетательным).

| Колонка | Описание | Единицы |
|---------|----------|---------|
| `DATA` | Дата замера | формат ДД.ММ.ГГГГ |
| `well` | Номер скважины | целое число |
| `TYPE` | Тип скважины | `Prod` (добывающая) / `Inj` (нагнетательная) |
| `WLPT` | Накопленная добыча жидкости | тонны |
| `WLPR` | Месячный дебит жидкости | тонн/мес |
| `WOMT` | Накопленная добыча нефти | тонны |
| `WOMR` | Месячный дебит нефти | тонн/мес |
| `WWIR` | Месячный объём закачки воды | м³/мес |
| `WWIT` | Накопленная закачка воды | м³ |
| `WTHP` | Устьевое давление | атм |
| `WBHP` | Забойное давление | атм |
| `WLPT_Diff` | Приращение накопленной добычи жидкости | тонны |
| `WOMT_Diff` | Приращение накопленной добычи нефти | тонны |
| `WWIT_Diff` | Приращение накопленной закачки | м³ |

### 2.2. Координаты скважин (`coords.txt`)

Текстовый файл, каждая строка содержит идентификатор скважины и координаты в пространстве:

```
well_id  x  y  z
```

Координаты `x`, `y` — плановые (м), `z` — абсолютная отметка (м, отрицательная для глубины).

### 2.3. Матрица расстояний (`well_distances.xlsx`)

Excel-файл с попарными расстояниями между скважинами (м). Симметричная матрица размера N×N, где N — количество скважин. Используется вместо евклидовых расстояний для учёта реальной геологической связности (по пласту, а не по прямой).

---

## 3. Этап 1: Загрузка и предобработка данных

**Модуль:** `src/wlpr_pipeline.py` → `load_raw_data()`, `prepare_model_frames()`  
**Модуль:** `src/data_preprocessing_advanced.py` → `PhysicsAwarePreprocessor`

### 3.1. Загрузка и нормализация

1. Чтение CSV с разделителем `;`
2. Переименование колонок в нижний регистр: `DATA` → `date`, `TYPE` → `type`
3. Приведение типов: `well` → строка, `date` → datetime
4. Удаление дубликатов по паре `(well, date)`
5. Удаление безымянных колонок (`Unnamed:`)

### 3.2. Физически-осведомлённая предобработка (до разделения train/test)

Применяется ко **всем** данным (не нарушает временную изоляцию, т.к. работает только с интерполяцией пропусков):

1. **Обнаружение структурных разрывов:** Относительное падение дебита `wlpr` свыше 70% от предыдущего значения помечается как остановка (`is_shutdown`). Обратное восстановление — как запуск (`is_startup`).

2. **Физически-осведомлённая интерполяция:** Пропуски в дебитах (`wlpr`, `womr`, `wwir`) заполняются с учётом кумулятивных показателей. Для кумулятивных колонок (`wlpt`, `womt`, `wwit`) применяется монотонная интерполяция.

### 3.3. Валидация данных

**Модуль:** `src/data_validation.py`

Pandera-схема проверяет:
- Наличие обязательных колонок
- Корректность типов данных
- Неотрицательность дебитов и накопленных показателей
- Корректность координат

### 3.4. Отбор скважин для моделирования

Критерии включения добывающей скважины:
- Тип последней записи: `PROD`
- Минимальная длина истории ≥ `min_history` = 60 месяцев
- Достаточно данных для горизонта прогноза + валидации

Результат: 13 добывающих скважин отобраны для моделирования из 20 общих (7 нагнетательных используются как источники закачки).

### 3.5. Реиндексация временных рядов

Для каждой скважины создаётся регулярная месячная сетка дат (`freq="MS"`) от первой до последней даты. Пропуски заполняются forward-fill, затем нулями.

### 3.6. Предобработка обучающей части (без утечки данных)

Критическая точка: `test_start` вычисляется как `target_end - (horizon - 1) * offset`. Все дальнейшие предобработки применяются **только к обучающей части** (до `test_start`):

1. **Обнаружение аномалий** (Elliptic Envelope / Minimum Covariance Determinant):
   - Признаки для детекции: `wlpr`, `wbhp`, `wwir`
   - Уровень контаминации: `contamination` = 0.05 (5%)
   - Метод: `sklearn.covariance.EllipticEnvelope` с робастной оценкой ковариации
   - Результат: помечается ~86 аномалий (~3.65%)

2. **Билатеральное сглаживание** (опционально, по умолчанию **выключено**):
   - При `preprocessing_enable_smoothing = True` применяется адаптивный билатеральный гауссов фильтр
   - Для каждой скважины и каждого замера вычисляется взвешенное среднее по окну:

   $$\hat{x}_i = \frac{\sum_{j \in W(i)} w_{\text{space}}(j) \cdot w_{\text{range}}(j) \cdot x_j}{\sum_{j \in W(i)} w_{\text{space}}(j) \cdot w_{\text{range}}(j)}$$

   где:
   - $w_{\text{space}}(j) = \exp\left(-\frac{(j - i)^2}{2 \sigma_{\text{space}}^2}\right)$ — весовая функция по временной близости
   - $w_{\text{range}}(j) = \exp\left(-\frac{(x_j - x_i)^2}{2 \sigma_{\text{range}}^2}\right)$ — весовая функция по близости значений
   - $\sigma_{\text{space}}$ = 3.0 (настраиваемый параметр)
   - $\sigma_{\text{range}}$ = MAD (медианное абсолютное отклонение) автоматически для каждой скважины
   
   Преимущество перед Савицкого-Голея: сохраняет резкие переходы (остановки/запуски), сглаживая только плавный шум.

### 3.7. Вычисление обводнённости

$$f_w = \frac{Q_{\text{жидк}} - Q_{\text{нефть}}}{Q_{\text{жидк}}} = \frac{\text{wlpr} - \text{womr}}{\max(\text{wlpr}, 10^{-6})}$$

Результат клипируется в диапазон $[0, 1]$, пропуски заполняются нулями. Колонка `fw` (watercut).

---

## 4. Этап 2: Конструирование признаков закачки

**Модуль:** `src/features_injection.py` → `build_injection_lag_features()`  
**Модуль:** `src/utils_lag.py` → `causal_xcorr_best_lag()`, `crm_exp_filter()`, `estimate_tau_window()`

Это ключевой этап, моделирующий влияние системы поддержания пластового давления (ППД) на добычу. Вдохновлён принципом суперпозиции из методологии ТюмГУ: вклад каждой нагнетательной скважины рассматривается отдельно.

### 4.1. Построение матрицы расстояний

Для каждой пары (добывающая $p$, нагнетательная $i$) вычисляется расстояние $d_{p,i}$:
- Приоритетно используется матрица из `well_distances.xlsx` (геологические расстояния)
- Если отсутствует — евклидово расстояние по координатам

Поддерживается анизотропия: $d_{\text{aniso}} = \sqrt{\Delta\mathbf{r}^T \mathbf{A}^{-1} \Delta\mathbf{r}}$, где $\mathbf{A}$ — матрица анизотропии.

### 4.2. Выбор ближайших нагнетательных скважин

Для каждой добывающей скважины выбираются `inj_top_k` = 5 ближайших нагнетательных (по расстоянию $d_{p,i}$).

### 4.3. Оценка временного окна лага

На основе уравнения пьезопроводности оценивается время прихода фронта давления от нагнетательной к добывающей скважине:

$$t_{\text{front}} = \frac{d^2}{4\alpha}$$

где $\alpha$ — коэффициент пьезопроводности:

$$\alpha = \frac{k}{\phi \cdot \mu \cdot c_t}$$

Параметры по умолчанию:
- $k$ = 100 мД (проницаемость)
- $\phi$ = 0.2 (пористость)
- $\mu$ = 1.0 сП (вязкость)
- $c_t$ = 1.0 × 10⁻³ 1/МПа (общая сжимаемость)

Диапазон кандидатных лагов: $[\text{lower}, \text{upper}]$ вокруг $t_{\text{front}}$ с множителем `tau_bound_multiplier` = 2.0.

### 4.4. Кросс-корреляционный подбор оптимального лага

Для каждой пары $(p, i)$ на **обучающих данных** (до `train_cutoff`) вычисляется кросс-корреляция между закачкой нагнетательной (со сдвигом) и дебитом добывающей:

$$\rho(\tau) = \text{corr}\left(\text{wwir}_i(t - \tau), \;\text{wlpr}_p(t)\right)$$

Выбирается лаг $\tau^*$ с максимальной корреляцией при минимальном перекрытии `min_overlap` = 6 месяцев.

### 4.5. Калибровка ядерной функции расстояния

Вес нагнетательной скважины $i$ для добывающей $p$ определяется ядерной функцией расстояния. Система оценивает 5 кандидатных ядер и выбирает лучшее по совокупной корреляции:

| Ядро | Формула | Параметры |
|------|---------|-----------|
| **IDW** (inverse distance weighting) | $w = d^{-p}$ | $p \in \{0.5, 1, 1.5, 2, 3, 4\}$ |
| Экспоненциальное | $w = \exp(-d / \lambda)$ | $\lambda \in \{200, 400, 600, 800, 1000\}$ м |
| Гауссово (RBF) | $w = \exp(-d^2 / 2\lambda^2)$ | $\lambda \in \{200, 400, 600, 800, 1000\}$ м |
| Матерновское | $w = K_\nu(d / \lambda)$ | $\lambda$, $\nu \in \{0.5, 1.5, 2.5\}$ |
| Рационально-квадратичное | $w = (1 + d^2 / 2\alpha\lambda^2)^{-\alpha}$ | $\lambda$, $\alpha \in \{0.5, 1, 2\}$ |

Калибровка выполняется перебором параметров с оценкой суммарной корреляции на обучающих данных.

### 4.6. Построение взвешенных признаков закачки

После определения весов $w_{p,i}$ и лагов $\tau_{p,i}$, для каждой добывающей скважины вычисляются:

1. **Суммарная взвешенная закачка с оптимальным лагом:**

$$\text{inj\_wwir\_lag\_weighted}_p(t) = \sum_{i=1}^{K} w_{p,i} \cdot \text{wwir}_i(t - \tau_{p,i})$$

2. **Суммарное взвешенное приращение закачки:**

$$\text{inj\_wwit\_diff\_lag\_weighted}_p(t) = \sum_{i=1}^{K} w_{p,i} \cdot \Delta\text{wwit}_i(t - \tau_{p,i})$$

3. **CRM-фильтрованная закачка** (экспоненциальный фильтр Capacitance-Resistance Model):

$$y(t) = e^{-\Delta t / \tau} \cdot y(t-1) + (1 - e^{-\Delta t / \tau}) \cdot x(t-1)$$

$$\text{inj\_wwir\_crm\_weighted}_p(t) = \sum_{i=1}^{K} w_{p,i} \cdot \text{CRM}(\text{wwir}_i, \tau_{p,i})$$

4. **Индивидуальные вклады нагнетательных (суперпозиция):**

$$\text{inj\_top}_k\_\text{contribution}_p(t) = w_{p,i_k} \cdot \text{wwir}_{i_k}(t - \tau_{p,i_k}), \quad k = 1, 2, 3$$

где $i_1, i_2, i_3$ — три ближайших нагнетательных. Это разложение даёт модели информацию о структуре влияния каждого нагнетателя по отдельности, в отличие от единого агрегата.

---

## 5. Этап 3: Пространственные и временные признаки

**Модуль:** `src/features_advanced.py`

### 5.1. Пространственные признаки

На основе координат скважин вычисляются:

| Признак | Формула | Описание |
|---------|---------|----------|
| `coord_x`, `coord_y`, `coord_z` | Из файла координат | Абсолютные координаты |
| `well_depth` | $\|z\|$ | Глубина скважины (м) |
| `dist_from_center` | $\sqrt{(x - \bar{x})^2 + (y - \bar{y})^2}$ | Расстояние от центроида месторождения |
| `quadrant_0..3` | One-hot по квадранту | Положение относительно центра (СВ/СЗ/ЮЗ/ЮВ) |

### 5.2. Эмбеддинги временных рядов (PCA)

Для каждой скважины строится скользящее окно размера `window` = 12 месяцев по признакам `[wlpr, womr]`. Матрица окон подаётся в PCA:

1. Для каждого момента $t$ формируется вектор: $\mathbf{x}_t = [x_{t-12}, x_{t-11}, ..., x_{t-1}]$ (конкатенация всех признаков за окно)
2. PCA обучается **только на обучающих данных** (до `train_cutoff`)
3. Трансформируются все окна (включая тестовые)
4. Результат: `ts_embed_0`, `ts_embed_1`, `ts_embed_2` — 3 главные компоненты

Эмбеддинги сжимают 12-месячную динамику в 3 числа, описывая латентное состояние скважины (тренд, сезонность, аномалии).

---

## 6. Этап 4: Физические признаки

**Модуль:** `src/wlpr_pipeline.py` → раздел "Productivity Index J(t)"

Вдохновлено статьёй PI-GNN (Physics-Informed Graph Neural Network, 2025).

### 6.1. Индекс продуктивности (Productivity Index)

Индекс продуктивности — безразмерный показатель, характеризующий способность скважины отдавать жидкость при заданном перепаде давления:

$$J(t) = \frac{Q_{\text{нефть}}(t)}{P_{\text{ref}} - P_{\text{уст}}(t)} = \frac{\text{wlpr}(t)}{\Delta P(t)}$$

где:
- $P_{\text{ref}}$ — референсное пластовое давление, оцениваемое как **95-й перцентиль** устьевого давления `wthp` **по обучающим данным** для каждой скважины
- $P_{\text{уст}}(t)$ = `wthp(t)` — текущее устьевое давление
- $\Delta P(t) = \max(P_{\text{ref}} - P_{\text{уст}}(t), 1.0)$ — перепад давления (drawdown), клипируемый снизу единицей для избежания деления на ноль

### 6.2. Перепад давления (Drawdown)

$$\text{dp\_drawdown}(t) = \max\left(P_{\text{ref}} - \text{wthp}(t), \; 1.0\right)$$

Эти два признака дают модели информацию о текущем энергетическом состоянии пласта вокруг скважины. Падение $J(t)$ сигнализирует о снижении проницаемости призабойной зоны или истощении запасов.

---

## 7. Этап 5: Графовые признаки

**Модуль:** `src/features_graph.py` → `build_graph_features()`

### 7.1. Построение графа скважин

Строится неориентированный взвешенный граф $G = (V, E)$:
- Вершины $V$: все 20 скважин (добывающие + нагнетательные)
- Рёбра $E$: полносвязный граф, вес ребра = близость (proximity) = $1 / d_{ij}$
- Дополнительный атрибут CRM: $f_{ij}$ — коэффициент связности из CRM-модели

### 7.2. Метрики центральности

Для каждой вершины (скважины) вычисляются 6 метрик центральности. После отбора признаков по MDI-важности (Random Forest) оставлена только `closeness_centrality`:

| Метрика | Формула | Описание | Используется |
|---------|---------|----------|:---:|
| `degree_centrality` | $C_D(v) = \frac{\deg(v)}{N-1}$ | Доля связей от максимума | нет |
| `betweenness_centrality` | $C_B(v) = \sum_{s \neq v \neq t} \frac{\sigma_{st}(v)}{\sigma_{st}}$ | Доля кратчайших путей через вершину | нет |
| `closeness_centrality` | $C_C(v) = \frac{N-1}{\sum_{u} d(v, u)}$ | Обратная средняя длина пути | **да** |
| `pagerank` | PageRank по близости | Важность по рекурсивной связности | нет |
| `eigenvector_centrality` | Собственный вектор матрицы смежности | Связь с другими важными узлами | нет |
| `clustering_coeff` | $C(v) = \frac{2 \cdot T(v)}{\deg(v)(\deg(v)-1)}$ | Кластеризованность окружения | нет |

### 7.3. Node2Vec эмбеддинги

Алгоритм Node2Vec (Grover & Leskovec, 2016) генерирует случайные блуждания по графу и обучает модель Word2Vec на последовательностях вершин:

- Параметры: `dimensions` = 4, `walk_length` = 20, `num_walks` = 50
- `p` = 1.0 (параметр возврата), `q` = 2.0 (параметр отдаления, q > 1 → BFS-подобное поведение)
- Веса рёбер: proximity = $1/d$
- Результат: `n2v_0`, `n2v_1`, `n2v_2`, `n2v_3` — 4-мерный вектор для каждой скважины

Эмбеддинги кодируют топологическое положение скважины в пространственной сети: близкие скважины в графе имеют похожие векторы.

### 7.4. Спектральные эмбеддинги

Основаны на собственных векторах нормированного лапласиана графа:

$$\mathbf{L}_{\text{norm}} = \mathbf{D}^{-1/2} \mathbf{L} \mathbf{D}^{-1/2}$$

где $\mathbf{L} = \mathbf{D} - \mathbf{A}$ — лапласиан, $\mathbf{D}$ — диагональная матрица степеней, $\mathbf{A}$ — матрица смежности (веса = proximity).

Берутся собственные векторы $\mathbf{v}_1, \mathbf{v}_2, \mathbf{v}_3, \mathbf{v}_4$, соответствующие наименьшим ненулевым собственным значениям. Вектор Фидлера ($\mathbf{v}_1$) описывает основное деление на кластеры, остальные — более тонкую структуру.

Результат: `spectral_0`, `spectral_1`, `spectral_2`, `spectral_3`.

### 7.5. CRM-признаки связности

Из таблицы пар (добывающая–нагнетательная) для каждой добывающей скважины вычисляются:

| Признак | Описание |
|---------|----------|
| `crm_max_connectivity` | Максимальный вес CRM-связи с нагнетательной (используется) |
| `crm_total_connectivity` | Суммарный вес всех связей (не используется) |
| `crm_num_injectors` | Количество связанных нагнетательных (не используется) |
| `crm_avg_lag` | Средний оптимальный лаг (не используется) |
| `crm_avg_tau` | Средняя постоянная времени CRM (не используется) |

### 7.6. Кластеризация скважин и спарсификация графа

Вдохновлено статьёй SGP-GCN (Sparsified Graph Prediction, 2025).

**Кластеризация:**
1. Для каждой добывающей скважины берётся нормализованный профиль добычи на обучающих данных
2. K-Means с перебором $k \in [2, 4]$, выбор $k$ по максимальному коэффициенту силуэта (silhouette score)
3. Результат: 2 кластера (silhouette = 0.635): основной (11 скважин) и малый (2 скважины)

**Спарсификация:**
- Межкластерные рёбра с proximity < медианы межкластерных весов удаляются
- Внутрикластерные рёбра сохраняются полностью
- Результат: удалено 11 из 22 межкластерных рёбер

Спарсифицированный граф используется **только** для агрегации соседей (этапы 7.7 и 7.8). Метрики центральности и эмбеддинги вычисляются на полном графе.

### 7.7. Агрегация признаков соседей (GCN-стиль)

Аналог одного слоя Graph Convolutional Network — для каждой скважины $v$ на каждом временном шаге $t$ вычисляется взвешенное среднее признаков $k$ ближайших соседей по спарсифицированному графу:

$$h_v(t) = \sum_{u \in \mathcal{N}_k(v)} \frac{w_{vu}}{\sum_{j \in \mathcal{N}_k(v)} w_{vj}} \cdot x_u(t)$$

где $w_{vu}$ = proximity (= $1/d_{vu}$), $\mathcal{N}_k(v)$ — $k$ = 5 ближайших соседей.

Агрегируемые признаки: `wlpr`, `womr`.  
Результат: `neighbor_avg_wlpr`, `neighbor_avg_womr`.

### 7.8. DTW-агрегация соседей

Вдохновлено статьёй STA-MGCN (Spatio-Temporal Adaptive Multi-Graph, 2025).

В отличие от географической агрегации, здесь близость определяется **динамическим подобием** производственных кривых через DTW (Dynamic Time Warping).

**Вычисление DTW-подобия:**

1. Для каждой скважины берётся ряд первых разностей (rate-of-change) дебита на обучающих данных: $\Delta x_t = x_t - x_{t-1}$
2. Ряд нормализуется: $\hat{x} = (\Delta x - \mu) / \sigma$
3. Попарно вычисляется DTW-расстояние через полную матрицу стоимости:

$$\text{DTW}(s_1, s_2) = \sqrt{C(n, m)}$$

где $C(i, j) = (s_1[i] - s_2[j])^2 + \min(C(i-1,j), C(i,j-1), C(i-1,j-1))$

4. Расстояние преобразуется в подобие через гауссово ядро:

$$\text{sim}(p, q) = \exp\left(-\frac{\text{DTW}(p, q)^2}{2\sigma^2}\right)$$

где $\sigma$ = медиана всех DTW-расстояний (self-tuning).

**Агрегация:**

Для каждой скважины выбираются $k$ = 5 наиболее подобных (по DTW) скважин. Вычисляется нормализованное взвешенное среднее их признаков:

$$h_v^{\text{dtw}}(t) = \sum_{u \in \mathcal{N}_k^{\text{dtw}}(v)} \frac{\text{sim}(v, u)}{\sum_j \text{sim}(v, j)} \cdot x_u(t)$$

Результат: `dtw_neighbor_avg_wlpr`, `dtw_neighbor_avg_womr`.

---

## 8. Этап 6: Модель Chronos-2

**Модуль:** `src/wlpr_pipeline.py` → `_build_chronos2_model()`, `_chronos2_predict()`

### 8.1. О модели Chronos-2

[Amazon Chronos-2](https://github.com/amazon-science/chronos-forecasting) — foundation-модель для прогнозирования временных рядов на базе архитектуры T5 (encoder-decoder Transformer). Предобучена на сотнях миллионов временных рядов. Работает в режиме **zero-shot**: не требует дообучения на целевых данных.

Ключевые возможности:
- Принимает мультивариативные ковариаты (past covariates и future covariates)
- Поддерживает probabilistic forecasting через likelihood models
- Cross-learning: обучение на нескольких рядах одновременно (group attention)

### 8.2. Подготовка данных для модели

Все 13 добывающих скважин подаются как **единый мультивариативный TimeSeries** через библиотеку Darts:

1. **Target series:** Pivot-таблица `[ds × well]` со значениями `wlpr` (target = `y`)
2. **Past covariates:** Историческе ковариаты, доступные только на обучающем периоде
3. **Future covariates:** Ковариаты, доступные и на прогнозном периоде (закачка, статические графовые признаки)

### 8.3. Список ковариат

**Исторические ковариаты (hist_exog, 19 признаков):**

| Группа | Признаки | Описание |
|--------|----------|----------|
| Промысловые | `wlpt`, `womt`, `womr`, `wthp` | Кумулятивная добыча, дебит нефти, устьевое давление |
| Закачка (суммарная) | `inj_wwir_lag_weighted`, `inj_wwit_diff_lag_weighted`, `inj_wwir_crm_weighted` | Взвешенная закачка с оптимальным лагом, приращение, CRM-фильтр |
| Закачка (суперпозиция) | `inj_top1_contribution`, `inj_top2_contribution`, `inj_top3_contribution` | Индивидуальные вклады 3 ближайших нагнетательных |
| Эмбеддинги PCA | `ts_embed_0`, `ts_embed_1`, `ts_embed_2` | 3 главные компоненты 12-месячного окна |
| Соседи (географ.) | `neighbor_avg_wlpr`, `neighbor_avg_womr` | GCN-агрегация по графу близости |
| Соседи (DTW) | `dtw_neighbor_avg_wlpr`, `dtw_neighbor_avg_womr` | Агрегация по динамическому подобию |
| Физические | `productivity_index`, `dp_drawdown` | Индекс продуктивности, перепад давления |

**Будущие ковариаты (futr_exog, 16 признаков):**

| Группа | Признаки | Описание |
|--------|----------|----------|
| Закачка | `inj_wwir_lag_weighted`, `inj_wwit_diff_lag_weighted`, `inj_wwir_crm_weighted` | Проектные режимы закачки |
| Суперпозиция | `inj_top1_contribution`, `inj_top2_contribution`, `inj_top3_contribution` | Индивидуальные вклады |
| Node2Vec | `n2v_0..3` | 4-мерные графовые эмбеддинги |
| Спектральные | `spectral_0..3` | 4-мерные спектральные эмбеддинги |
| Центральность | `closeness_centrality` | Центральность по близости |
| CRM | `crm_max_connectivity` | Максимальная CRM-связность |

**Статические ковариаты (static_exog, 8 признаков):**

| Признак | Описание |
|---------|----------|
| `coord_x`, `coord_y`, `coord_z` | Координаты скважины |
| `well_depth` | Глубина |
| `dist_from_center` | Расстояние от центра месторождения |
| `quadrant_0..3` | Квадрант расположения |

### 8.4. Параметры модели

| Параметр | Значение | Описание |
|----------|----------|----------|
| `hub_model_name` | `amazon/chronos-2` | Предобученная модель из HuggingFace |
| `input_chunk_length` | `min(48, train_length - horizon - 1)` | Адаптивная длина входного окна |
| `output_chunk_length` | 6 | Горизонт прогноза (месяцев) |
| `likelihood` | `QuantileRegression([0.1, 0.5, 0.9])` | Вероятностный режим |

### 8.5. Вероятностное прогнозирование

Модель обучается предсказывать три квантиля распределения:

- $q_{0.1}$ — 10-й перцентиль (нижняя граница 80% доверительного интервала)
- $q_{0.5}$ — медиана (основной прогноз)
- $q_{0.9}$ — 90-й перцентиль (верхняя граница 80% доверительного интервала)

Функция потерь — Pinball loss (quantile loss):

$$L_q(y, \hat{y}) = \begin{cases} q \cdot (y - \hat{y}), & \text{если } y \geq \hat{y} \\ (1 - q) \cdot (\hat{y} - y), & \text{если } y < \hat{y} \end{cases}$$

---

## 9. Этап 7: Кросс-валидация

**Модуль:** `src/wlpr_pipeline.py` → `run_walk_forward_validation()`

### 9.1. Схема Walk-Forward Cross-Validation

Используется expanding window (расширяющееся окно) с фиксированным горизонтом валидации:

```
Fold 1: [====TRAIN====][=VAL=]........................
Fold 2: [======TRAIN======][=VAL=]...................
Fold 3: [========TRAIN========][=VAL=]...............
Fold 4: [==========TRAIN==========][=VAL=]..........
Fold 5: [============TRAIN============][=VAL=]......
Fold 6: [==============TRAIN==============][=VAL=]..
                                                [TEST]
```

Параметры:
- `cv_folds` = 6
- `cv_step` = 6 (месяцев между фолдами)
- `horizon` = 6 (месяцев — длина валидационного окна)

### 9.2. Полная перестройка признаков на каждом фолде

Критически важно: на каждом фолде **все** признаки пересчитываются с нуля, используя только данные до `cutoff_date` фолда:

1. Injection features: лаги и веса калибруются заново
2. Time series embeddings: PCA обучается только на обучающих окнах фолда
3. Productivity Index: $P_{\text{ref}}$ вычисляется по обучающей части фолда
4. Graph features: DTW-подобие считается по обучающей части фолда
5. Production clustering: кластеризация по обучающей истории фолда

Это предотвращает утечку данных из будущего в прошлое.

### 9.3. Агрегация метрик

Метрики агрегируются по фолдам взвешенно по числу наблюдений:

$$\overline{M} = \frac{\sum_{f=1}^{F} n_f \cdot M_f}{\sum_{f=1}^{F} n_f}$$

где $n_f$ — количество наблюдений в фолде $f$, $M_f$ — значение метрики.

---

## 10. Этап 8: Метрики и оценка

**Модуль:** `src/metrics_extended.py`  
**Модуль:** `src/metrics_reservoir.py`

### 10.1. Основные метрики ошибки

| Метрика | Формула | Описание |
|---------|---------|----------|
| MAE | $\frac{1}{N} \sum \|y_i - \hat{y}_i\|$ | Средняя абсолютная ошибка |
| RMSE | $\sqrt{\frac{1}{N} \sum (y_i - \hat{y}_i)^2}$ | Среднеквадратичная ошибка |
| MAPE | $\frac{100}{N} \sum \frac{\|y_i - \hat{y}_i\|}{\|y_i\| + \varepsilon}$ | Средняя абсолютная процентная ошибка |
| SMAPE | $\frac{100}{N} \sum \frac{2\|y_i - \hat{y}_i\|}{\|y_i\| + \|\hat{y}_i\| + \varepsilon}$ | Симметричная MAPE |
| **WMAPE** | $\frac{\sum \|y_i - \hat{y}_i\|}{\sum \|y_i\|}$ | **Взвешенная MAPE** (основная метрика) |
| MASE | $\frac{\text{MAE}}{\text{MAE}_{\text{naive}}}$ | Масштабированная ошибка (относительно наивного прогноза) |

### 10.2. Статистические метрики

| Метрика | Формула | Описание |
|---------|---------|----------|
| R² | $1 - \frac{SS_{\text{res}}}{SS_{\text{tot}}}$ | Коэффициент детерминации |
| NSE | $1 - \frac{\sum(y_i - \hat{y}_i)^2}{\sum(y_i - \bar{y})^2}$ | Эффективность Нэша-Сатклиффа |
| KGE | $1 - \sqrt{(r-1)^2 + (\alpha-1)^2 + (\beta-1)^2}$ | Эффективность Клинга-Гупты |
| Correlation | $\text{corr}(y, \hat{y})$ | Коэффициент Пирсона |

### 10.3. Вспомогательные метрики

| Метрика | Формула | Описание |
|---------|---------|----------|
| PBIAS | $\frac{\sum(y_i - \hat{y}_i)}{\sum y_i} \times 100$ | Процентный сдвиг |
| Index of Agreement | $1 - \frac{\sum(y_i - \hat{y}_i)^2}{\sum(\|y_i - \bar{y}\| + \|\hat{y}_i - \bar{y}\|)^2}$ | Индекс согласия Уилмотта |
| MBE | $\frac{1}{N}\sum(y_i - \hat{y}_i)$ | Средняя ошибка смещения |

### 10.4. Текущие результаты

| Метрика | Тест (6 мес) | CV (6 фолдов) |
|---------|-------------|---------------|
| WMAPE | 0.394% | 1.410% |
| MAE | 0.603 т/мес | 2.158 т/мес |
| R² | 0.9999 | 0.9978 |
| KGE | 0.9982 | 0.9861 |

---

## 11. Архитектура модулей

```
src/
├── artifacts.py                  # CLI, сохранение артефактов, точка входа (main)
├── caching.py                    # Кэширование промежуточных результатов
├── config.py                     # PipelineConfig (все параметры)
├── data_preprocessing_advanced.py # Outlier detection, bilateral smoothing, imputation
├── data_validation.py            # Pandera-схемы, валидация данных
├── features_advanced.py          # Spatial, Fourier, PCA embeddings
├── features_graph.py             # Graph construction, centrality, Node2Vec, spectral,
│                                 # clustering, sparsification, neighbor aggregation, DTW
├── features_injection.py         # Injection lag features, kernel calibration, CRM,
│                                 # superposition (top-N contributions), multiscale lags
├── logging_config.py             # Настройка логирования
├── metrics_extended.py           # Все метрики (MAE, RMSE, MAPE, WMAPE, R², NSE, KGE, ...)
├── metrics_reservoir.py          # Reservoir-specific метрики
├── mlflow_tracking.py            # MLflow трекинг экспериментов
├── physics_loss_advanced.py      # Физический лосс (не используется с Chronos-2)
├── utils_lag.py                  # Кросс-корреляция, CRM-фильтр, оценка окна лага
├── visualization.py              # PDF-визуализация прогнозов, истории, остатков
├── visualization_features.py     # PDF-анализ признаков (7 страниц)
└── wlpr_pipeline.py              # Основной пайплайн: загрузка → обработка → признаки →
                                  # Chronos-2 → CV → оценка
```

### Последовательность вызовов (основной поток)

```
main() [artifacts.py]
  ├── load_raw_data()                    # CSV → DataFrame с предобработкой
  ├── load_coordinates()                 # Координаты скважин
  ├── load_distance_matrix()             # Матрица расстояний
  ├── validate_and_report()              # Валидация данных
  ├── prepare_model_frames()             # Основной этап конструирования признаков:
  │     ├── get_target_wells()           #   Отбор добывающих скважин
  │     ├── reindex_series()             #   Регулярная сетка дат
  │     ├── _compute_watercut()          #   Обводнённость
  │     ├── PhysicsAwarePreprocessor     #   Outlier detection (train only)
  │     ├── _apply_injection_lag_features()  # Закачка + суперпозиция
  │     ├── _finalize_prod_dataframe()   #   unique_id, y, time_idx
  │     ├── create_spatial_features()    #   Координаты, квадранты
  │     ├── create_time_series_embeddings()  # PCA-эмбеддинги
  │     ├── Productivity Index J(t)      #   Физические признаки
  │     └── build_graph_features()       #   Граф, центральность, Node2Vec,
  │           ├── cluster + sparsify     #   спектральные, DTW, соседи
  │           ├── neighbor aggregation
  │           └── DTW neighbor aggregation
  ├── run_walk_forward_validation()      # 6-fold walk-forward CV
  │     └── (полная перестройка на каждом фолде)
  ├── train_and_forecast()               # Финальный прогноз Chronos-2
  ├── evaluate_predictions()             # Метрики
  └── save_artifacts()                   # PDF, JSON, CSV
```

---

## 12. Конфигурация

Все параметры собраны в dataclass `PipelineConfig` (`src/config.py`):

### 12.1. Общие параметры

| Параметр | Значение | Описание |
|----------|----------|----------|
| `horizon` | 6 | Горизонт прогноза (месяцев) |
| `freq` | `"MS"` | Частота временного ряда (начало месяца) |
| `min_history` | 60 | Минимальная длина истории для включения скважины |
| `input_size` | 48 | Базовая длина входного окна Chronos-2 |
| `random_seed` | 42 | Зерно генератора случайных чисел |

### 12.2. Кросс-валидация

| Параметр | Значение | Описание |
|----------|----------|----------|
| `cv_folds` | 6 | Количество фолдов |
| `cv_step` | 6 | Шаг между фолдами (месяцев) |
| `cv_enabled` | True | Включение/выключение CV |

### 12.3. Закачка

| Параметр | Значение | Описание |
|----------|----------|----------|
| `inj_top_k` | 5 | Количество ближайших нагнетательных |
| `inj_kernel_calibrate` | True | Автокалибровка ядра |
| `use_crm_filter` | True | Включение CRM-фильтра |
| `tau_bound_multiplier` | 2.0 | Множитель окна лага |
| `lag_min_overlap` | 6 | Минимальное перекрытие для кросс-корреляции |

### 12.4. Предобработка

| Параметр | Значение | Описание |
|----------|----------|----------|
| `preprocessing_outlier_contamination` | 0.05 | Доля ожидаемых аномалий |
| `preprocessing_enable_smoothing` | False | Билатеральное сглаживание (выключено) |
| `preprocessing_bilateral_sigma_space` | 3.0 | Параметр временного окна фильтра |

### 12.5. Графовые параметры

| Параметр | Значение | Описание |
|----------|----------|----------|
| `graph_n2v_dimensions` | 4 | Размерность Node2Vec |
| `graph_spectral_components` | 4 | Количество спектральных компонент |
| `graph_neighbor_k` | 5 | Количество соседей для агрегации |
| `graph_dtw_k` | 5 | Количество DTW-соседей |
| `graph_sparsify` | True | Спарсификация графа |
| `graph_sparsify_max_k` | 4 | Максимум кластеров K-Means |
| `graph_sparsify_inter_quantile` | 0.5 | Порог обрезки межкластерных рёбер |

### 12.6. Chronos-2

| Параметр | Значение | Описание |
|----------|----------|----------|
| `chronos_hub_model_name` | `"amazon/chronos-2"` | Идентификатор модели HuggingFace |
| `chronos_probabilistic` | True | Вероятностный режим |
| `chronos_quantiles` | `[0.1, 0.5, 0.9]` | Прогнозируемые квантили |

---

## 13. Запуск пайплайна

### 13.1. Установка зависимостей

```bash
pip install -r requirements.txt
```

Основные зависимости: `darts`, `torch`, `transformers`, `accelerate`, `networkx`, `node2vec`, `gensim`, `scikit-learn`, `pandas`, `numpy`, `scipy`, `matplotlib`, `pandera`.

### 13.2. Команда запуска

```bash
python -m src.artifacts \
    --data-path MODEL_22.09.25.csv \
    --coords-path coords.txt \
    --distances-path well_distances.xlsx \
    --output-dir artifacts
```

### 13.3. Выходные артефакты

Все артефакты сохраняются в директорию `artifacts/`:

| Файл | Описание |
|------|----------|
| `forecast.pdf` | Прогноз по каждой скважине с 80% доверительным интервалом |
| `full_history.pdf` | Полная история + прогноз с разметкой train/val/test |
| `residuals.pdf` | Анализ остатков по скважинам |
| `feature_analysis.pdf` | 7-страничный анализ признаков (корреляции, MI, графовые метрики) |
| `metrics.json` | Все метрики (overall, per-well, по горизонтам, reservoir-specific) |
| `predictions.csv` | Таблица прогнозов с квантилями |
| `data_quality_report.json` | Отчёт о качестве данных |
| `cv_results.json` | Результаты кросс-валидации по фолдам |

---

## 14. Литература и источники

### 14.1. Модель Chronos-2

- Ansari, A. F., Stella, L., Turkmen, C., Zhang, X., Mercado, P., et al. (2024). "Chronos: Learning the Language of Time Series." *arXiv:2403.07815*. https://github.com/amazon-science/chronos-forecasting
- Amazon Chronos-2 (2025). Обновлённая версия с поддержкой ковариат и мультивариативного прогнозирования. HuggingFace: `amazon/chronos-2`

### 14.2. Графовые методы для нефтедобычи

- STA-MGCN: Spatio-Temporal Adaptive Multi-Graph Convolutional Network (2025). DTW-подобие для динамической топологии графа скважин. Использование первых разностей дебита + гауссово ядро для матрицы подобия.
- SGP-GCN: Sparsified Graph Prediction with GCN (2025). Кластеризация скважин по профилям добычи (K-Means + silhouette), удаление слабых межкластерных рёбер для предотвращения передачи "искажённой информации" от непохожих скважин.
- PI-GNN: Physics-Informed Graph Neural Network (2025). Использование индекса продуктивности $J(t)$ и перепада давления как физически-осведомлённых признаков для графовых нейросетей.

### 14.3. Методология ТюмГУ

- Методология Тюменского государственного университета для оптимизации заводнения. Принцип суперпозиции: влияние каждой нагнетательной скважины моделируется отдельно (PINN для дебита жидкости + LSTM для обводнённости). Декомпозиция: $Q_{\text{нефть}} = Q_{\text{жидк}} \cdot (1 - f_w)$.

### 14.4. Физические модели

- CRM (Capacitance-Resistance Model): Sayarpour, M., et al. (2011). Экспоненциальный фильтр для моделирования инерционного влияния закачки на добычу: $y(t) = e^{-\Delta t/\tau} y(t-1) + (1 - e^{-\Delta t/\tau}) x(t-1)$.
- Уравнение пьезопроводности: $\frac{\partial P}{\partial t} = \alpha \frac{\partial^2 P}{\partial x^2}$, где $\alpha = k / (\phi \mu c_t)$. Используется для оценки временного окна лага закачки.

### 14.5. Алгоритмы

- Node2Vec: Grover, A. & Leskovec, J. (2016). "node2vec: Scalable Feature Learning for Networks." *KDD 2016*.
- Spectral Clustering: Von Luxburg, U. (2007). "A tutorial on spectral clustering." *Statistics and Computing*.
- Elliptic Envelope: Rousseeuw, P. J. & Van Driessen, K. (1999). Minimum Covariance Determinant для робастного обнаружения аномалий.

### 14.6. Библиотеки

- [Darts](https://unit8co.github.io/darts/) — фреймворк для прогнозирования временных рядов (обёртка над Chronos-2)
- [NetworkX](https://networkx.org/) — построение и анализ графов
- [node2vec](https://github.com/eliorc/node2vec) — реализация Node2Vec
- [scikit-learn](https://scikit-learn.org/) — PCA, K-Means, Elliptic Envelope, silhouette score
- [Gensim](https://radimrehurek.com/gensim/) — Word2Vec (бэкенд для Node2Vec)
